159 (151 genbank, 8 refseq, these are duplicates, will need to remove) reference nematode genome assemblies were taken from NCBI genbank. Only included sequences at the scaffold level or above from the 2010 or newer.

# copy fna files from downloaded species folders and put in single flder for busco 
find ./* -type f -exec cp -n {} . \;

# To parralellize this and save time, I split the 159 genomes into 10 (15-16 genomes per folder) separate folders, then looped busco on each of them

for f1 in *.fna
do
busco -c 24 -i $f1 -l nematoda_odb10 --augustus -o ${f1%%.fna}"" -m geno
done
# takes a very long time to run busco on this many

# Next needed an outgroup
# Previously used out groups for neamtoda include kinorhyncha, priaplulida, tardigrada, nematomorpha
# there are no nematomorpha, kinorhyncha, or nematomorpha genomes available
# there are 5 targigrade and 1 priapulida reference genomes available
# Going to try them as an outgroup
# They were downloaded and run against the nematoda_odb10 database, as above.

# My next task was to decide on a cutoff for busco quality. Some of the busco scores of the assemblies were low
# This paper "A Practical Guide to Design and Assess a Phylogenomic Study" indicates a cutoff of 80% could be valid
# However it is known the nematoda_odb10 has some bias towards certain clades, and against tylenchina species, so it makes sense to lower this threshold given that knowledge
# Here I checked and removed the buscos lower than 65% from the directory
for dir in /srv/scratch/z5228384/RhabGenomePaper/Phylogenomics/ncbi_dataset/data/FinishedBuscoFolders/*/; do
    for file in "$dir"/*.txt; do
        species=$(basename "$dir")
        echo -n "$species $(grep 'C:' "$file" | awk '{print $1, $2}') " >> output.txt
    done
    echo "" >> output.txt
done
sed 's/^.*C:\([0-9.]*%\).*$/\1/' output.txt > BuscoScores.txt
cut -f 1 output.txt > AssemblyNames.txt
paste AssemblyNames.txt BuscoScores.txt > FinalBuscoScores.txt
# I then used excel to see which are less than 65% and generated a list of them called LowBuscoScores.csv
mkdir LowBuscos
cut -d ',' -f 1 LowBuscoScores.csv | tr -d '\r' | xargs -I {} mv {} LowBuscos/ # this will move the low scoring busco folders to a folder called LowBuscoScores

#It is also worth noting i cannot apply this 70% cutoff to the outgroup, because it wont have very high scores compared to nematoda_odb10, but is needed for the analysis.

# Once I have the single copy busco amino acids from the species set that I want, next i needed to get all the single copy genes from every species,
    #rename them accordingly, then put them all in a directory together for further analysis

# Loop through original subdirectories
for dir in */; do

    # Change to single_copy_busco_sequences subdirectory
    cd $dir/run_nematoda_odb10/busco_sequences/single_copy_busco_sequences

    # Get abbreviation for directory name
    abbrv=$(basename $dir)

    # Make renamed directory
    mkdir renamed

    # Loop through .faa files in single_copy_busco_sequences directory
    for file in *.faa; do

        # Copy file to renamed directory with abbreviation in name
        cp $file renamed/${abbrv}_${file}

        # Replace > with >$abbrv| in copied file
        sed -i "s/^>/>$abbrv|/" renamed/${abbrv}_${file}

        # Convert sequence names to upper case and write to new file
        cut -f 1 -d ":" renamed/${abbrv}_${file} | tr '[:lower:]' '[:upper:]' > renamed/${abbrv}_${file}.1

        # Move new file to original file name
        mv renamed/${abbrv}_${file}.1 renamed/${abbrv}_${file}

    done

    # Move everything to foldder for further analysis
    mv renamed/* /srv/scratch/z5228384/RhabGenomePaper/Phylogenomics/SingleCopyAminoAcids

    # Change back to original directory
    cd ../../../../

done

# The next step is to create a list of the peptides and which species has each of them
# This is done because I want to exclude peptides that are not present in at least 3 different species
# First you must copy each full_table.tsv file from each species into a new folder, and name each of them 
#create list of peptides


for file in full_table_*.tsv
do
grep -v "^#" ${file} | awk '$2=="Complete" {print $1}' >> complete_busco_ids.txt
done
sort complete_busco_ids.txt |uniq -c > complete_busco_ids_with_counts.txt
awk '$NF >  0 {print $2}' complete_busco_ids_with_counts.txt >  final_busco_ids.txt

while read line; do
cat *_${line}.faa > /srv/scratch/z5228384/MysteryWorm/BuscoPhylo/speciesfiles/DEC/${line}_aa.fasta;
done<final_busco_ids.txt






# parallelise modelfinder for IQTREE
# 
mkdir output
find *.fasta | parallel --bar 'iqtree -s {} -m MF -msub nuclear -pre output/{}'  
