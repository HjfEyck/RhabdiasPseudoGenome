# We have already masked repetitive regions from the use of repeatmasker for the annotation of repeat sequences
# First I masked numts in the final assembly that had already masked repeats, using NUMTfinder from slimsuite to model the NUMTs, and bedtools to mask them.

cd /srv/scratch/z5228384/RhabGenomePaper/PostAssembly/NumtMasking
NUMT=/srv/scratch/z5228384/tools/numtfinder/code/
MT=/srv/scratch/z5228384/RhabGenomePaper/mtDNA/FinalmtDNA/animal_mt.K115.complete.graph1.1.path_sequence.fasta
module load bedtools2/2.30.0 python
python2 $NUMT/numtfinder.py forks=24 seqin=Step_8_FinalTidy.diploidocus.fasta.masked mtdna=$MT basefile=./numtMASKED
bedtools maskfasta -soft -fi Step_8_FinalTidy.diploidocus.fasta.softmasked -bed numtMASKED.numtsearch.unique.gff -fo Step_8_FinalTidy.diploidocus_repmasked_numtmasked_softMasked.fasta 

# Next step was to simplify the contigs names in the assembly, which is recommended by Braker2 https://github.com/Gaius-Augustus/BRAKER
# Headers currently look like ">scaffold1288_size5585_pilon"
sed 's/^>\(.*\)_size.*/>\1/' Step_8_FinalTidy.diploidocus_repmasked_numtmasked_softMasked.fasta > Step_8_FinalTidy.diploidocus_repmasked_numtmasked_softMasked_cleanHeaders.fasta
#Headers now are only ">scaffold1288"

# Now that repeats and NUMTs are masked in the assembly, we can annotate it using GeMoMa and braker

#First GeMoMa
#Navigate to working directory
cd /srv/scratch/z5228384/RhabGenomePaper/PostAssembly/Anottation
conda activate annotation_env
conda install -c bioconda gemoma
#Define variables
PPN=24
export JAVA_TOOL_OPTIONS="-Xmx247G"
export _JAVA_OPTIONS="-Xmx247G"
TARGET=Step_8_FinalTidy.diploidocus_repmasked_numtmasked_softMasked_cleanHeaders.fasta
RFDIR=/srv/scratch/z5228384/RhabGenomePaper/PostAssembly/Anottation/referenceGenomes
# Run gemoma
GeMoMa GeMoMaPipeline \
threads=$PPN \
t=$TARGET \
outdir=RhabGem_10species_softMask \
tblastn=false \
GeMoMa.m=15000 \
GeMoMa.Score=ReAlign \
AnnotationFinalizer.r=NO \
s=own i=C_elegans a=$RFDIR/C_elegans.gff g=$RFDIR/C_elegans.fa \
s=own i=C_briggsae a=$RFDIR/C_briggsae.gff g=$RFDIR/C_briggsae.fa \
s=own i=C_nigoni a=$RFDIR/C_nigoni.gff g=$RFDIR/C_nigoni.fa \
s=own i=C_remanei a=$RFDIR/C_remanei.gff g=$RFDIR/C_remanei.fa \
s=own i=P_pacificus a=$RFDIR/P_pacificus.gff g=$RFDIR/P_pacificus.fa \
s=own i=S_carpocapsae a=$RFDIR/S_carpocapsae.gff g=$RFDIR/S_carpocapsae.fa \
s=own i=S_ratti2 a=$RFDIR/S_ratti.gff g=$RFDIR/S_ratti.fa \
s=own i=L_loa a=$RFDIR/L_loa.gff g=$RFDIR/L_loa.fa \
s=own i=N_americanus a=$RFDIR/N_americanus.gff g=$RFDIR/N_americanus.fa \
s=own i=T_spiralis a=$RFDIR/T_spiralis.gff g=$RFDIR/T_spiralis.fa


# Now run braker

RAW=/srv/scratch/z5228384/RhabGenomePaper/Reads/ONTreads
minimap2 -t 20 -a -x map-ont Step_8_FinalTidy.diploidocus_repmasked_numtmasked_cleanHeaders.fasta $RAW/rhabont_allreads_5000.fastq.gz | samtools view -@ 20 -S -b - | samtools sort -@ 20 - -o HypoLR_sorted.bam


module load braker cdbfasta/

WORKDIR="/srv/scratch/z5228384/RhabGenomePaper/PostAssembly/Anottation/braker"

# Copy directory we dont have permissions for
cp -r /apps/z_install_tree/linux-rocky8-ivybridge/gcc-12.2.0/augustus-3.4.0-duwzji3wkoy43fsbfld4uedt7jxrojr5/config/ $WORKDIR/
# Change the variable to our newly copied directory
export AUGUSTUS_CONFIG_PATH="/srv/scratch/canetoad/CaneToad-Jan18/annotation/2023-03-29.braker2/config"

#specify genome
GENOME="/srv/scratch/z5228384/RhabGenomePaper/PostAssembly/Anottation/Step_8_FinalTidy.diploidocus_repmasked_numtmasked_cleanHeaders.fasta"

# Katana's BRAKER missed scripts/ folder. Mis-named as lib/ #
# copy the lib/ folder and name it as scripts/ to working directory (Because the program will look for scripts in the working directory as well #
mkdir scripts/
cp -r /apps/z_install_tree/linux-rocky8-ivybridge/gcc-12.2.0/braker-2.1.6-qtiqf7qgxmbxeabbzejrpjh2k6v2ig2l/lib scripts/
# make sure biopython is installed
pip3 install biopython

braker.pl --species Rpseudo --genome=$GENOME --softmasking --cores 16 --workingdir $WORKDIR/BRAKER.run --gff3

braker.pl --species=yourRhabdiasPseudo --genome=genome.fasta
