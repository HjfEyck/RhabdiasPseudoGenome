# We have already masked repetitive regions from the use of repeatmasker for the annotation of repeat sequences
# First I masked numts in the final assembly that had already masked repeats, using NUMTfinder from slimsuite to model the NUMTs, and bedtools to mask them.

cd /srv/scratch/z5228384/RhabGenomePaper/PostAssembly/NumtMasking
NUMT=/srv/scratch/z5228384/tools/numtfinder/code/
MT=/srv/scratch/z5228384/RhabGenomePaper/mtDNA/FinalmtDNA/animal_mt.K115.complete.graph1.1.path_sequence.fasta
module load bedtools2/2.30.0 python
python2 $NUMT/numtfinder.py forks=24 seqin=Step_8_FinalTidy.diploidocus.fasta.masked mtdna=$MT basefile=./numtMASKED
bedtools maskfasta -soft -fi Step_8_FinalTidy.diploidocus.fasta.softmasked -bed numtMASKED.numtsearch.unique.gff -fo Step_8_FinalTidy.diploidocus_repmasked_numtmasked_softMasked.fasta 

# Next step was to simplify the contigs names in the assembly, which is recommended by Braker2 https://github.com/Gaius-Augustus/BRAKER
# Headers currently look like ">scaffold1288_size5585_pilon"
sed 's/^>\(.*\)_size.*/>\1/' Step_8_FinalTidy.diploidocus_repmasked_numtmasked_softMasked.fasta > Step_8_FinalTidy.diploidocus_repmasked_numtmasked_softMasked_cleanHeaders.fasta
#Headers now are only ">scaffold1288"

# Now that repeats and NUMTs are masked in the assembly, we can annotate it using GeMoMa and braker

#First GeMoMa
#Navigate to working directory
cd /srv/scratch/z5228384/RhabGenomePaper/PostAssembly/Anottation
conda activate annotation_env
conda install -c bioconda gemoma
#Define variables
PPN=24
export JAVA_TOOL_OPTIONS="-Xmx247G"
export _JAVA_OPTIONS="-Xmx247G"
TARGET=Step_8_FinalTidy.diploidocus_repmasked_numtmasked_softMasked_cleanHeaders.fasta
RFDIR=/srv/scratch/z5228384/RhabGenomePaper/PostAssembly/Anottation/referenceGenomes
# Run gemoma
GeMoMa GeMoMaPipeline \
threads=$PPN \
t=$TARGET \
outdir=RhabGem_10species_softMask \
tblastn=false \
GeMoMa.m=15000 \
GeMoMa.Score=ReAlign \
AnnotationFinalizer.r=NO \
s=own i=C_elegans a=$RFDIR/C_elegans.gff g=$RFDIR/C_elegans.fa \
s=own i=C_briggsae a=$RFDIR/C_briggsae.gff g=$RFDIR/C_briggsae.fa \
s=own i=C_nigoni a=$RFDIR/C_nigoni.gff g=$RFDIR/C_nigoni.fa \
s=own i=C_remanei a=$RFDIR/C_remanei.gff g=$RFDIR/C_remanei.fa \
s=own i=P_pacificus a=$RFDIR/P_pacificus.gff g=$RFDIR/P_pacificus.fa \
s=own i=S_carpocapsae a=$RFDIR/S_carpocapsae.gff g=$RFDIR/S_carpocapsae.fa \
s=own i=S_ratti2 a=$RFDIR/S_ratti.gff g=$RFDIR/S_ratti.fa \
s=own i=L_loa a=$RFDIR/L_loa.gff g=$RFDIR/L_loa.fa \
s=own i=N_americanus a=$RFDIR/N_americanus.gff g=$RFDIR/N_americanus.fa \
s=own i=T_spiralis a=$RFDIR/T_spiralis.gff g=$RFDIR/T_spiralis.fa

GeMoMa AnnotationEvidence a=final_annotation.gff g=../Step_8_FinalTidy.diploidocus_repmasked_numtmasked_softMasked_cleanHeaders.fasta

number of detected CDS lines: 123888
number of detected genes: 18066
number of detected transcripts: 20475


# Now run braker

module load braker cdbfasta/

WORKDIR="/srv/scratch/z5228384/RhabGenomePaper/PostAssembly/Anottation/braker"

# Copy directory we dont have permissions for
cp -r /apps/z_install_tree/linux-rocky8-ivybridge/gcc-12.2.0/augustus-3.4.0-duwzji3wkoy43fsbfld4uedt7jxrojr5/config/ $WORKDIR/
# Change the variable to our newly copied directory
export AUGUSTUS_CONFIG_PATH="/srv/scratch/canetoad/CaneToad-Jan18/annotation/2023-03-29.braker2/config"

#specify genome
GENOME="/srv/scratch/z5228384/RhabGenomePaper/PostAssembly/Anottation/Step_8_FinalTidy.diploidocus_repmasked_numtmasked_cleanHeaders.fasta"

# Katana's BRAKER missed scripts/ folder. Mis-named as lib/ #
# copy the lib/ folder and name it as scripts/ to working directory (Because the program will look for scripts in the working directory as well #
mkdir scripts/
cp -r /apps/z_install_tree/linux-rocky8-ivybridge/gcc-12.2.0/braker-2.1.6-qtiqf7qgxmbxeabbzejrpjh2k6v2ig2l/lib scripts/
# make sure biopython is installed
pip3 install biopython
# run in esmode because we only have a genome, and no rnaseq or protein data
# check programs work
check_install.bash

# If a new key is needed, which is likely, we need to get a new one
wget http://topaz.gatech.edu/GeneMark/tmp/GMtool_IH8XG/gm_key_64.gz
gunzip gm_key_64.gz
mv gm_key_64 ~/.gm_key
cd /mnt/griffin/chrwhe/software/braker_dependencies/gmes_linux_64/
./check_install.bash

braker.pl --species Rpseudo --genome=$GENOME --esmode --softmasking --cores 20 --workingdir $WORKDIR/BRAKER.run --gff3

braker.pl --species=yourRhabdiasPseudo --genome=genome.fasta

GeMoMa AnnotationEvidence a=final_annotation.gff g=../Step_8_FinalTidy.diploidocus_repmasked_numtmasked_softMasked_cleanHeaders.fasta
number of detected CDS lines: 152174
number of detected genes: 12978
number of detected transcripts: 12978

# Merge annotations from braker and gemoma
GeMoMa GAF g=Braker_annotation_with_attributes.gff g=GeMoMa_annotation_with_attributes.gff outdir=./
input   filtered transcripts    final transcripts supported     final genes supported
input0        12497                 4584                            4584
input1        20475                 18066                           18066





# first must extract seqs from agat

busco -c 8 -i .fasta -l nematoda_odb10 --augustus -o RhabBuscoNEM -m prot
